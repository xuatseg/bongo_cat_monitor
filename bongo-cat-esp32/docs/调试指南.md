# ESP32 项目设置和调试指南

## 项目迁移总结

本文档描述了将 Arduino `.ino` 项目迁移到基于 PlatformIO 的 ESP32 项目结构的过程。

## 完成的关键步骤

### 1. 项目结构设置
- 创建了 `bongo-cat-esp32/` 文件夹，遵循命名规范
- 将文件组织为 PlatformIO 标准结构：
  ```
  bongo-cat-esp32/
  ├── src/main.cpp          # 主应用程序（从 .ino 转换）
  ├── include/              # 头文件
  ├── lib/                  # 本地库
  ├── platformio.ini        # 构建配置
  └── docs/                 # 文档
  ```

### 2. PlatformIO 配置
- **开发板**: `esp32dev` (ESP32-WROOM-32 模组)
- **框架**: Arduino
- **上传速度**: 460800 波特率
- **监视器速度**: 115200 波特率

### 3. 解决的主要问题

#### 问题 1: 串口冲突
**现象**: `Serial` 对象未声明
```
error: 'Serial' was not declared in this scope
```

**根本原因**: USB CDC 配置标志导致 Serial 重定义

**解决方案**: 移除冲突的 USB CDC 构建标志：
```ini
; 移除这些标志
-DARDUINO_USB_CDC_ON_BOOT=1
-DARDUINO_USB_MODE=1
-DARDUINO_USB_CDC_MODE=1
```

#### 问题 2: LVGL 配置路径
**现象**: LVGL 找不到 `lv_conf.h`
```
fatal error: ../../lv_conf.h: No such file or directory
```

**解决方案**: 
- 添加 `LV_CONF_INCLUDE_SIMPLE` 构建标志
- 创建 `extra_script.py` 自动复制配置文件
- 将 `lv_conf.h` 放置在项目根目录

#### 问题 3: TFT_eSPI 配置
**现象**: `TFT_WIDTH` 和 `TFT_HEIGHT` 未定义
```
error: 'TFT_WIDTH' was not declared in this scope
```

**解决方案**: 通过 `platformio.ini` 中的构建标志定义所有 TFT_eSPI 设置：
```ini
build_flags = 
    -DTFT_WIDTH=240
    -DTFT_HEIGHT=320
    -DILI9341_2_DRIVER=1
    -DTFT_MISO=12
    -DTFT_MOSI=13
    -DTFT_SCLK=14
    -DTFT_CS=15
    -DTFT_DC=2
    -DTFT_RST=-1
    -DTFT_BL=27
    ; ... 更多设置
```

#### 问题 4: 显示屏无内容
**现象**: 背光亮，但屏幕空白（全白）

**根本原因**: setup() 中缺少背光初始化

**解决方案**: 添加背光控制：
```cpp
#ifdef TFT_BL
pinMode(TFT_BL, OUTPUT);
digitalWrite(TFT_BL, HIGH);
#endif
```

#### 问题 5: 动画文件路径
**现象**: 找不到动画精灵文件
```
fatal error: animations/body/standardbody1.c: No such file or directory
```

**解决方案**: 更新 `animations_sprites.h` 中的包含路径：
```cpp
// 之前
#include "animations/body/standardbody1.c"

// 之后
#include "../lib/bongo_cat_animations/src/body/standardbody1.c"
```

## 硬件配置

### 显示屏引脚 (ILI9341)
- **MISO**: GPIO 12
- **MOSI**: GPIO 13
- **SCLK**: GPIO 14
- **CS**: GPIO 15
- **DC**: GPIO 2
- **RST**: -1 (未使用)
- **BL**: GPIO 27 (背光)
- **Touch CS**: GPIO 33

### 显示设置
- **驱动**: ILI9341_2_DRIVER
- **分辨率**: 240x320
- **颜色深度**: 16位 (RGB565)
- **字节交换**: 启用 (`LV_COLOR_16_SWAP 1`)
- **反转**: ON

## 构建过程

### 前置要求
```bash
# 安装 PlatformIO
pip install platformio
```

### 构建命令
```bash
# 导航到项目目录
cd bongo-cat-esp32

# 仅构建
pio run

# 构建并上传
pio run --target upload

# 构建、上传并监视
pio run --target upload --target monitor

# 清理构建
pio run --target clean
```

### 辅助脚本
- **copy_configs.sh**: 手动复制配置文件
- **build.sh**: 带错误检查的构建脚本
- **extra_script.py**: 构建前自动复制配置（自动运行）

## 验证步骤

### 串口输出（成功）
```
🐱 Bongo Cat with Sprites Starting...
📂 Settings loaded from EEPROM
🔦 Backlight initialized on pin 27
📺 Initializing TFT display...
📺 TFT initialized, setting rotation...
📺 Filling screen white...
📺 Screen filled!
🎨 Initializing LVGL...
🐱 Sprite manager initialized
🎨 Creating Bongo Cat UI...
🎨 Setting background color...
🎨 Creating labels...
🎨 CPU label created
🎨 Rendering initial sprite...
🎨 UI creation complete!
✅ Bongo Cat Ready!
🖼️ First flush callback triggered!
🖼️ Area: x1=0 y1=0 x2=239 y2=9
```

### 预期显示
- 白色背景
- 中央的 Bongo Cat 动画
- CPU/RAM/WPM 标签（左上角）
- 时间显示（右上角）

## 库依赖

```ini
lib_deps = 
    lvgl/lvgl@^8.3.11
    bodmer/TFT_eSPI@^2.5.43
    WiFi@^1.0.0
```

## 代码注释和日志

所有代码注释和串口日志使用英文，以提高可访问性和可维护性。

## 未来改进

1. 考虑添加 OTA（无线）更新支持
2. 添加 Wi-Fi 配置门户
3. 实现省电模式
4. 添加触摸屏支持（硬件已配置）

## 故障排除

### 显示问题
1. 检查引脚连接是否与 `platformio.ini` 定义匹配
2. 验证背光引脚是否正确供电
3. 检查 SPI 频率（如果出现花屏可降低）

### 编译问题
1. 清理构建目录：`pio run --target clean`
2. 运行配置复制脚本：`./copy_configs.sh`
3. 检查库版本是否匹配

### 上传问题
1. 降低 `platformio.ini` 中的上传速度
2. 上传时按住 BOOT 按钮
3. 检查 USB 线是否支持数据传输

## 参考资料

- [PlatformIO ESP32 文档](https://docs.platformio.org/en/latest/platforms/espressif32.html)
- [LVGL 文档](https://docs.lvgl.io/)
- [TFT_eSPI 库](https://github.com/Bodmer/TFT_eSPI)


